<?php
//decode by QQ:270656184 http://www.yunlu99.com/
namespace Admin\Controller;use Admin\Controller\AdminController;class JnooocnController extends AdminController {public function __construct(){parent::__construct ();$this->upurl ="http://";}protected function _infoModule(){return array('menu' => array(array('name' => '管理首页', 'url' => U('Index/index'), 'icon' => 'dashboard', )), 'info' => array('name' => '管理首页', 'description' => '站点运行信息', 'icon' => 'home', ));}public function index(){$breadCrumb =array('首页'=>U('Index/index'));$this->assign('breadCrumb',$breadCrumb);$this->assign('enduptime',C('enduptime'));$this->assign('curv',C('upvstionnow'));$this->adminDisplay();}public function rmdirs($dir){$dir_arr =scandir($dir);foreach($dir_arr as $key=>$val){if($val == '.' || $val == '..'){}else {if(is_dir($dir.'/'.$val)){if(@rmdir($dir.'/'.$val)== 'true'){}else $this->rmdirs($dir.'/'.$val);}else unlink($dir.'/'.$val);}}}public function checkup(){$url =$this->upurl."/check/domain/".$_SERVER["HTTP_HOST"];$re =A("Home/Site")->curl_get_contents($url);echo $re;}public function doup(){$v =C("vstion");$lastv =C("upvstionnow");$url =$this->upurl."/doup/domain/".$_SERVER["HTTP_HOST"]."/v/".$v."/lastv/".$lastv;$re =A("Home/Site")->curl_get_contents($url);echo $re;}public function doact(){$act =I("post.act",'','trim');$sqlupid =C("sqlupid");$v =C("vstion");$url =$this->upurl."/".$act."/domain/".$_SERVER["HTTP_HOST"]."/sqlid/".$sqlupid;if($act!='jieya')$re =A("Home/Site")->curl_get_contents($url);sleep(1);$re2 =json_decode($re,ture);switch($act){case "showinfo": $msglist =$re2["data"];foreach($msglist as $key=> $val){$msglist[$key]['content'] =str_replace('
','<br>',$val['content']);}$this->success($msglist);exit;break;case 'upsql': if($v!=$re2["data"]['v']){$this->error("版本信息错误，升级失败！");}if($re2["data"]['dosql']){M()->query($re2["data"]['dosql']);$dberr =M()->getDbError();$go =1;if($dberr){$msg =$dberr;$go =0;if(strstr($dberr,'1062')){$msg ="1062此条sql已存在，跳过执行……";$go =1;}if(strstr($dberr,'1061')){$msg ="1061此条sql已存在，跳过执行……";$go =1;}if(strstr($dberr,'1060')){$msg ="1061此条sql已存在，跳过执行……";$go =1;}}if($go==0){$this->error($msg."。升级失败请联系Jnooo.cn");}if($re2["next_id"])M("Config")->where("name='sqlupid'")->setField("data",$re2["next_id"]);}break;case 'upzip': $path=ROOT_PATH;$url2 =$re2["url"];$newfname =$path . basename($url2);$file =fopen($url2, 'rb');if ($file){$newf =fopen($newfname, 'wb');if ($newf){while (!feof($file)){fwrite($newf, fread($file, 1024 * 8), 1024 * 8);}}}else {$result['status'] ='1';$result['msg'] =$re2["status"]==0 ? $re2["msg"]:'下载的安装包打开失败，无法更新，请检查根目录下 是否有写入权限。' . '';$this->ajaxReturn($result);exit;}if ($file){fclose($file);}sleep(2);S('newfile',$newfname);S('thisup',$re2['thisup']);$result['act'] ='jieya';$result['status'] ='1';$result['msg'] ='升级包下载完毕。正在执行解压……' . '';$this->ajaxReturn($result);exit;break;case 'jieya': $path =S("newfile");if (is_file($path)&& file_exists($path)){require_once(ROOT_PATH."Public/zip/zip.php");$zip =new \PHPZip();$re =$zip->unZip($path,ROOT_PATH);$goo =0;if($re==-1){if(PHP_OS=='Linux'){exec("unzip -o ".$path);$goo =1;}else{$result['status'] ='0';$result['msg'] ='解压失败！请手动解压根目录zip文件。覆盖根目录。' . '';$this->rmdirs(ROOT_PATH."Runtime/");$this->ajaxReturn($result);exit;}}else{$goo =1;}if($goo==1){unlink($path);M('Config')->where('name=\'enduptime\'')->setField('data',time());M('Config')->where('name=\'upvstionnow\'')->setField('data',S('thisup'));$result['status'] ='1';$result['msg'] ='升级成功，请检查网站是否正常使用！' . '';$this->rmdirs(ROOT_PATH."Runtime/");$this->ajaxReturn($result);}else{$result['status'] ='0';$result['msg'] ='解压失败，升级失败，请手动解压根目录下zip文件。……' . '';$this->rmdirs(ROOT_PATH."Runtime/");$this->ajaxReturn($result);}exit;}else{$result['status'] ='1';$result['msg'] ='解压失败，请确认服务器是否有写入权限' . '';$this->ajaxReturn($result);exit;}break;}echo $re;}public function test(){exit;$path=ROOT_PATH."20151121.zip";require_once(ROOT_PATH.'Public/zip/zip.php');$zip =new \PHPZip();exec('unzip -o '.$path);exit;dump($re);dump(PHP_OS);}}